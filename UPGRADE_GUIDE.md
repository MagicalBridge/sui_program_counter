# Sui Move åˆçº¦å‡çº§æŒ‡å—

æœ¬æŒ‡å—å°†å¸®åŠ©æ‚¨äº†è§£å¦‚ä½•ä½¿ç”¨æ–°å¢çš„å‡çº§åŠŸèƒ½æ¥å‡çº§æ‚¨çš„Counteræ™ºèƒ½åˆçº¦ã€‚

## ğŸ†• æ–°å¢åŠŸèƒ½

### åˆçº¦å‡çº§æ”¯æŒ
- âœ… ä½¿ç”¨`Publisher`å’Œ`UpgradeCap`å®ç°åˆçº¦å‡çº§
- âœ… éƒ¨ç½²è€…æƒé™æ§åˆ¶ï¼ˆåªæœ‰éƒ¨ç½²è€…å¯ä»¥å‡çº§åˆçº¦ï¼‰
- âœ… å…¨å±€ç‰ˆæœ¬è·Ÿè¸ª
- âœ… è‡ªåŠ¨åŒ–å‡çº§è„šæœ¬

### æƒé™æ¨¡å‹
- **ä»»ä½•äººéƒ½å¯ä»¥**: åˆ›å»ºCounterã€ä½¿ç”¨è‡ªå·±çš„Counterï¼ˆincrementã€decrementã€resetã€set_valueç­‰ï¼‰
- **åªæœ‰éƒ¨ç½²è€…å¯ä»¥**: å‡çº§åˆçº¦ã€ç®¡ç†å…¨å±€é…ç½®

### æ–°å¢åˆçº¦åŠŸèƒ½

#### ä»»ä½•äººéƒ½å¯ä»¥ä½¿ç”¨çš„åŠŸèƒ½ï¼š
- `create()`: åˆ›å»ºæ–°çš„Counterå¯¹è±¡
- `increment(counter)`: é€’å¢è‡ªå·±çš„è®¡æ•°å™¨
- `increment_by(counter, amount)`: æ‰¹é‡é€’å¢è‡ªå·±çš„è®¡æ•°å™¨
- `decrement(counter)`: é€’å‡è‡ªå·±çš„è®¡æ•°å™¨
- `reset(counter)`: é‡ç½®è‡ªå·±çš„è®¡æ•°å™¨
- `set_value(counter, value)`: è®¾ç½®è‡ªå·±çš„è®¡æ•°å™¨å€¼
- `get_value(counter)`: è·å–è®¡æ•°å™¨å€¼

#### åªæœ‰éƒ¨ç½²è€…å¯ä»¥ä½¿ç”¨çš„åŠŸèƒ½ï¼š
- `upgrade_global_version(config, admin_cap)`: å‡çº§å…¨å±€ç‰ˆæœ¬å·

#### å…¬å…±æŸ¥è¯¢åŠŸèƒ½ï¼š
- `get_global_version(config)`: è·å–å…¨å±€ç‰ˆæœ¬å·
- `get_deployer(config)`: è·å–éƒ¨ç½²è€…åœ°å€
- `is_deployer(config, addr)`: æ£€æŸ¥æ˜¯å¦ä¸ºéƒ¨ç½²è€…

## ğŸ“‹ å‰ç½®æ¡ä»¶

1. **å·²éƒ¨ç½²çš„åˆçº¦**: ç¡®ä¿æ‚¨å·²ç»æœ‰ä¸€ä¸ªéƒ¨ç½²çš„Counteråˆçº¦
2. **å‡çº§æƒé™**: æ‚¨å¿…é¡»æ‹¥æœ‰`UpgradeCap`å¯¹è±¡
3. **å……è¶³ä½™é¢**: ç¡®ä¿è´¦æˆ·æœ‰è¶³å¤Ÿçš„SUIç”¨äºgasè´¹ç”¨
4. **ç¯å¢ƒé…ç½®**: `.env`æ–‡ä»¶åŒ…å«å¿…è¦çš„é…ç½®ä¿¡æ¯

## ğŸš€ å‡çº§æ­¥éª¤

### 1. é¦–æ¬¡éƒ¨ç½²ï¼ˆè·å–å‡çº§æƒé™ï¼‰

å¦‚æœè¿™æ˜¯æ‚¨çš„é¦–æ¬¡éƒ¨ç½²ï¼š

```bash
# éƒ¨ç½²åˆ°æœ¬åœ°ç½‘ç»œ
npm run deploy

# æˆ–éƒ¨ç½²åˆ°æµ‹è¯•ç½‘
npm run deploy:testnet
```

éƒ¨ç½²æˆåŠŸåï¼Œæ‚¨å°†è·å¾—ï¼š
- ğŸ“¦ **åŒ…ID**: åˆçº¦çš„å”¯ä¸€æ ‡è¯†ç¬¦
- ğŸ”‘ **Publisher ID**: å‘å¸ƒè€…æƒé™å¯¹è±¡IDï¼ˆç”¨äºåˆ›å»ºå‡çº§æƒé™ï¼‰
- ğŸ‘‘ **AdminCap ID**: ç®¡ç†å‘˜æƒé™å¯¹è±¡IDï¼ˆåªæœ‰éƒ¨ç½²è€…æ‹¥æœ‰ï¼‰
- ğŸŒ **GlobalConfig ID**: å…¨å±€é…ç½®å¯¹è±¡IDï¼ˆå…±äº«å¯¹è±¡ï¼Œä»»ä½•äººéƒ½å¯ä»¥è¯»å–ï¼‰

è¿™äº›ä¿¡æ¯ä¼šè‡ªåŠ¨ä¿å­˜åˆ°`.env`æ–‡ä»¶ä¸­ã€‚

### 2. ä¿®æ”¹åˆçº¦ä»£ç 

åœ¨`sources/Counter.move`ä¸­è¿›è¡Œæ‚¨æƒ³è¦çš„ä¿®æ”¹ã€‚ä¾‹å¦‚ï¼š
- æ·»åŠ æ–°å‡½æ•°
- ä¿®æ”¹ç°æœ‰é€»è¾‘
- æ·»åŠ æ–°å­—æ®µï¼ˆæ³¨æ„ï¼šä¸èƒ½åˆ é™¤ç°æœ‰å­—æ®µï¼‰

### 3. æ‰§è¡Œå‡çº§

```bash
# å‡çº§åˆ°å½“å‰æ¿€æ´»çš„ç½‘ç»œ
npm run upgrade

# æˆ–å‡çº§åˆ°ç‰¹å®šç½‘ç»œ
npm run upgrade:testnet
npm run upgrade:devnet
```

### 4. éªŒè¯å‡çº§

å‡çº§å®Œæˆåï¼š
1. è¿è¡Œæµ‹è¯•ç¡®ä¿åŠŸèƒ½æ­£å¸¸ï¼š`npm test`
2. æ£€æŸ¥æ–°çš„åŒ…IDå·²æ›´æ–°åˆ°`.env`æ–‡ä»¶
3. éªŒè¯æ–°åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ

## ğŸ“ ç¯å¢ƒé…ç½®

ç¡®ä¿æ‚¨çš„`.env`æ–‡ä»¶åŒ…å«ä»¥ä¸‹é…ç½®ï¼š

```env
# ç½‘ç»œé…ç½®
SUI_NETWORK=localnet

# åŒ…ID
PACKAGE_ID=0x...

# å‘å¸ƒè€…æƒé™å¯¹è±¡ID
PUBLISHER_ID=0x...

# ç®¡ç†å‘˜æƒé™å¯¹è±¡IDï¼ˆåªæœ‰éƒ¨ç½²è€…æ‹¥æœ‰ï¼‰
ADMIN_CAP_ID=0x...

# å…¨å±€é…ç½®å¯¹è±¡IDï¼ˆå…±äº«å¯¹è±¡ï¼Œä»»ä½•äººéƒ½å¯ä»¥è¯»å–ï¼‰
GLOBAL_CONFIG_ID=0x...
```

## ğŸ› ï¸ å‡çº§è„šæœ¬ä½¿ç”¨

### åŸºæœ¬ç”¨æ³•

```bash
# ä½¿ç”¨å½“å‰æ¿€æ´»çš„ç½‘ç»œ
npm run upgrade

# æŒ‡å®šç½‘ç»œ
npm run upgrade:testnet
npm run upgrade:devnet
npm run upgrade:localnet
```

### ç›´æ¥ä½¿ç”¨TypeScript

```bash
# ä½¿ç”¨å½“å‰ç½‘ç»œ
npx ts-node scripts/upgrade.ts

# æŒ‡å®šç½‘ç»œ
npx ts-node scripts/upgrade.ts testnet
```

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

1. **æ‰¾ä¸åˆ°åŒ…ID**
   ```
   é”™è¯¯: æ‰¾ä¸åˆ°ç°æœ‰çš„åŒ…IDï¼Œè¯·å…ˆå‘å¸ƒåˆçº¦
   è§£å†³: ç¡®ä¿.envæ–‡ä»¶å­˜åœ¨ä¸”åŒ…å«PACKAGE_ID
   ```

2. **æ‰¾ä¸åˆ°å‘å¸ƒè€…æƒé™**
   ```
   é”™è¯¯: æ‰¾ä¸åˆ°å‘å¸ƒè€…æƒé™IDï¼Œæ— æ³•å‡çº§åˆçº¦
   è§£å†³: ç¡®ä¿.envæ–‡ä»¶åŒ…å«PUBLISHER_IDï¼Œä¸”å½“å‰åœ°å€æ‹¥æœ‰è¯¥å¯¹è±¡
   ```

3. **æƒé™ä¸è¶³**
   ```
   é”™è¯¯: åˆçº¦å‡çº§å¤±è´¥
   è§£å†³: ç¡®ä¿å½“å‰åœ°å€æ˜¯å‡çº§æƒé™çš„æ‰€æœ‰è€…
   ```

4. **Gasä¸è¶³**
   ```
   é”™è¯¯: äº¤æ˜“å¤±è´¥
   è§£å†³: ç¡®ä¿è´¦æˆ·æœ‰è¶³å¤Ÿçš„SUIä½™é¢
   ```

### æ£€æŸ¥å‘½ä»¤

```bash
# æ£€æŸ¥å½“å‰åœ°å€
sui client active-address

# æ£€æŸ¥ä½™é¢
sui client balance

# æ£€æŸ¥æ‹¥æœ‰çš„å¯¹è±¡
sui client objects

# æ£€æŸ¥ç½‘ç»œç¯å¢ƒ
sui client envs
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹æ€§**: å‡çº§æ—¶ä¸èƒ½åˆ é™¤ç°æœ‰çš„å…¬å…±å‡½æ•°æˆ–æ›´æ”¹å…¶ç­¾å
2. **æ•°æ®ç»“æ„**: ä¸èƒ½åˆ é™¤ç»“æ„ä½“ä¸­çš„ç°æœ‰å­—æ®µï¼Œåªèƒ½æ·»åŠ æ–°å­—æ®µ
3. **æƒé™ç®¡ç†**: å¦¥å–„ä¿ç®¡æ‚¨çš„`Publisher`å¯¹è±¡ï¼Œå®ƒæ˜¯å‡çº§åˆçº¦çš„å”¯ä¸€å‡­è¯
4. **æµ‹è¯•**: åœ¨ä¸»ç½‘å‡çº§å‰ï¼Œè¯·åœ¨æµ‹è¯•ç½‘å……åˆ†æµ‹è¯•
5. **å¤‡ä»½**: å‡çº§å‰è¯·å¤‡ä»½é‡è¦æ•°æ®å’Œé…ç½®
6. **æƒé™åˆ†ç¦»**: 
   - åˆçº¦å‡çº§æƒé™ï¼šåªæœ‰éƒ¨ç½²è€…æ‹¥æœ‰ï¼ˆé€šè¿‡Publisher/UpgradeCapï¼‰
   - Counterä½¿ç”¨æƒé™ï¼šä»»ä½•äººéƒ½å¯ä»¥åˆ›å»ºå’Œç®¡ç†è‡ªå·±çš„Counterå¯¹è±¡
   - å…¨å±€é…ç½®ç®¡ç†ï¼šåªæœ‰éƒ¨ç½²è€…å¯ä»¥ä¿®æ”¹ï¼ˆé€šè¿‡AdminCapï¼‰

## ğŸ“ å‡çº§æ—¥å¿—

å»ºè®®åœ¨æ¯æ¬¡å‡çº§åè®°å½•ï¼š
- å‡çº§æ—¶é—´
- æ–°åŒ…ID
- å‡çº§å†…å®¹
- æµ‹è¯•ç»“æœ

è¿™æœ‰åŠ©äºè·Ÿè¸ªåˆçº¦çš„æ¼”è¿›å†å²ã€‚

## ğŸ¯ æœ€ä½³å®è·µ

1. **æ¸è¿›å¼å‡çº§**: æ¯æ¬¡å‡çº§åŒ…å«å°‘é‡æ›´æ”¹ï¼Œä¾¿äºè°ƒè¯•
2. **å……åˆ†æµ‹è¯•**: åœ¨å‡çº§å‰è¿›è¡Œå…¨é¢æµ‹è¯•
3. **æ–‡æ¡£æ›´æ–°**: åŠæ—¶æ›´æ–°ç›¸å…³æ–‡æ¡£
4. **ç‰ˆæœ¬ç®¡ç†**: ä½¿ç”¨`upgrade_version`å‡½æ•°è·Ÿè¸ªç‰ˆæœ¬
5. **æƒé™åˆ†ç¦»**: è€ƒè™‘å°†å‡çº§æƒé™å’Œæ—¥å¸¸ç®¡ç†æƒé™åˆ†å¼€

## ğŸ“– ä½¿ç”¨ç¤ºä¾‹

### æ™®é€šç”¨æˆ·ä½¿ç”¨Counter

```bash
# ä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥åˆ›å»ºè‡ªå·±çš„Counter
sui client call --package $PACKAGE_ID --module counter --function create

# ä½¿ç”¨è‡ªå·±çš„Counterï¼ˆéœ€è¦Counterå¯¹è±¡IDï¼‰
sui client call --package $PACKAGE_ID --module counter --function increment --args $COUNTER_ID

# æ‰¹é‡é€’å¢
sui client call --package $PACKAGE_ID --module counter --function increment_by --args $COUNTER_ID 5

# é‡ç½®è‡ªå·±çš„Counter
sui client call --package $PACKAGE_ID --module counter --function reset --args $COUNTER_ID

# è®¾ç½®è‡ªå·±çš„Counterå€¼
sui client call --package $PACKAGE_ID --module counter --function set_value --args $COUNTER_ID 100
```

### éƒ¨ç½²è€…ç®¡ç†å…¨å±€é…ç½®

```bash
# åªæœ‰éƒ¨ç½²è€…å¯ä»¥å‡çº§å…¨å±€ç‰ˆæœ¬ï¼ˆéœ€è¦AdminCapï¼‰
sui client call --package $PACKAGE_ID --module counter --function upgrade_global_version --args $GLOBAL_CONFIG_ID $ADMIN_CAP_ID

# ä»»ä½•äººéƒ½å¯ä»¥æŸ¥è¯¢å…¨å±€ä¿¡æ¯
sui client call --package $PACKAGE_ID --module counter --function get_global_version --args $GLOBAL_CONFIG_ID
sui client call --package $PACKAGE_ID --module counter --function get_deployer --args $GLOBAL_CONFIG_ID
```

### æƒé™éªŒè¯

```bash
# æ£€æŸ¥æŸä¸ªåœ°å€æ˜¯å¦ä¸ºéƒ¨ç½²è€…
sui client call --package $PACKAGE_ID --module counter --function is_deployer --args $GLOBAL_CONFIG_ID $ADDRESS
```

## ğŸ”— ç›¸å…³é“¾æ¥

- [Sui Move å®˜æ–¹æ–‡æ¡£](https://docs.sui.io/concepts/sui-move-concepts)
- [åŒ…å‡çº§æŒ‡å—](https://docs.sui.io/concepts/sui-move-concepts/packages/upgrade)
- [Sui CLI å‚è€ƒ](https://docs.sui.io/references/cli)